<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Spring-Mass System Simulation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      /* Enhanced canvas interactions for touch devices */
      canvas {
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      /* Smooth scrolling for better UX */
      html {
        scroll-behavior: smooth;
      }

      /* Enhanced focus styles for accessibility */
      input:focus,
      button:focus {
        outline: 2px solid #4f46e5;
        outline-offset: 2px;
      }

      /* Smooth transitions for interactive elements */
      button,
      input {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Sidebar transition */
      .sidebar {
        transition: transform 0.3s ease-in-out;
      }

      .sidebar.hidden {
        transform: translateX(-100%);
      }

      /* Main content transition */
      .main-content {
        transition: all 0.3s ease-in-out;
      }

      .main-content.expanded {
        margin-left: 0;
        width: 100%;
      }

      /* Simulation container styles */
      .simulation-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 2rem;
        transition: all 0.3s ease-in-out;
      }

      .simulation-container.expanded {
        padding: 1rem;
      }

      /* Canvas container styles */
      .canvas-container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        transition: all 0.3s ease-in-out;
      }

      .canvas-container.expanded {
        max-width: 1400px;
      }

      /* Tab styles */
      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .tab-button {
        @apply px-4 py-2.5 text-sm font-medium transition-all relative;
        letter-spacing: 0.025em;
      }

      .tab-button.active {
        @apply text-indigo-800 font-semibold;
        background: linear-gradient(
          to bottom,
          rgba(79, 70, 229, 0.1),
          rgba(79, 70, 229, 0.05)
        );
      }

      .tab-button.active::before {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 24px;
        height: 3px;
        background: linear-gradient(90deg, #4338ca, #4f46e5);
        border-radius: 3px;
        box-shadow: 0 0 8px rgba(79, 70, 229, 0.4);
        transition: all 0.3s ease;
      }

      .tab-button:hover::before {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 16px;
        height: 2px;
        background: rgba(79, 70, 229, 0.4);
        border-radius: 2px;
        transition: all 0.3s ease;
      }

      .tab-button.active:hover::before {
        width: 32px;
        box-shadow: 0 0 12px rgba(79, 70, 229, 0.5);
      }

      .tab-button:not(.active) {
        @apply text-gray-600 hover:text-gray-800;
      }

      .tab-button:not(.active):hover {
        background: linear-gradient(
          to bottom,
          rgba(79, 70, 229, 0.05),
          transparent
        );
      }

      /* Tab container */
      .tab-container {
        @apply relative bg-gray-100/50 rounded-lg p-1;
      }

      .tab-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(
          to right,
          transparent,
          rgba(229, 231, 235, 0.8),
          transparent
        );
      }

      /* Tab content styles */
      .tab-content {
        @apply mt-4;
      }

      .tab-content.active {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col bg-gray-50 text-gray-800">
    <div class="flex flex-1 h-screen relative">
      <!-- Sidebar Toggle Button -->
      <button
        id="sidebar-toggle"
        class="absolute top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-md hover:bg-gray-100 transition-colors border border-gray-200 flex items-center justify-center w-8 h-8">
        <i class="fas fa-chevron-up text-gray-600 text-sm"></i>
      </button>

      <!-- Settings Panel -->
      <aside
        id="settings-sidebar"
        class="sidebar w-80 bg-white border-r border-gray-200 flex flex-col p-4 shadow-xl h-full overflow-y-auto">
        <h2
          class="text-lg font-bold mb-4 text-gray-800 border-b border-gray-200 pb-2 pl-12">
          Simulation Settings
        </h2>

        <!-- Tab Navigation -->
        <div class="tab-container flex justify-between mb-4">
          <button class="tab-button active flex-1" data-tab="physics">
            Physics
          </button>
          <button class="tab-button flex-1" data-tab="presets">Presets</button>
          <button class="tab-button flex-1" data-tab="controls">
            Controls
          </button>
          <button class="tab-button flex-1" data-tab="guide">Guide</button>
        </div>

        <!-- Tab Contents -->
        <div class="flex-1">
          <!-- Physics Tab -->
          <div id="physics-tab" class="tab-content active">
            <form id="settings-form" class="flex flex-col gap-4">
              <div
                class="bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-100">
                <h3
                  class="text-xs font-semibold text-gray-700 mb-2 uppercase tracking-wide">
                  Physics Parameters
                </h3>
                <div class="space-y-3">
                  <div>
                    <label
                      class="block text-xs font-medium text-gray-700 mb-1"
                      for="stiffness">
                      Spring Stiffness (k)
                    </label>
                    <input
                      id="stiffness"
                      name="stiffness"
                      type="number"
                      step="0.1"
                      min="0.1"
                      max="1000"
                      value="100"
                      required
                      class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition shadow-sm bg-white" />
                  </div>
                  <div>
                    <label
                      class="block text-xs font-medium text-gray-700 mb-1"
                      for="damping">
                      Damping (c)
                    </label>
                    <input
                      id="damping"
                      name="damping"
                      type="number"
                      step="0.01"
                      min="0"
                      max="10"
                      value="0.05"
                      required
                      class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition shadow-sm bg-white" />
                  </div>
                  <div>
                    <label
                      class="block text-xs font-medium text-gray-700 mb-1"
                      for="gravity">
                      Gravity (g)
                    </label>
                    <input
                      id="gravity"
                      name="gravity"
                      type="number"
                      step="0.1"
                      min="0"
                      max="50"
                      value="9.8"
                      required
                      class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition shadow-sm bg-white" />
                  </div>
                  <div>
                    <label
                      class="block text-xs font-medium text-gray-700 mb-1"
                      for="mass">
                      Mass (m)
                    </label>
                    <input
                      id="mass"
                      name="mass"
                      type="number"
                      step="0.01"
                      min="0.01"
                      max="10"
                      value="1.0"
                      required
                      class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition shadow-sm bg-white" />
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- Presets Tab -->
          <div id="presets-tab" class="tab-content">
            <div
              class="bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-100">
              <h3
                class="text-xs font-semibold text-gray-700 mb-2 uppercase tracking-wide">
                Quick Presets
              </h3>
              <div class="grid grid-cols-1 gap-2">
                <button
                  type="button"
                  class="preset-btn text-xs py-2 px-3 bg-white text-gray-700 rounded-lg hover:bg-indigo-100 hover:text-indigo-800 transition shadow-sm hover:shadow-md border border-gray-200"
                  data-k="100"
                  data-c="0.15"
                  data-g="9.8">
                  <i class="fas fa-globe mr-2"></i>Default Physics
                </button>
                <button
                  type="button"
                  class="preset-btn text-xs py-2 px-3 bg-white text-gray-700 rounded-lg hover:bg-indigo-100 hover:text-indigo-800 transition shadow-sm hover:shadow-md border border-gray-200"
                  data-k="150"
                  data-c="0.1"
                  data-g="0">
                  <i class="fas fa-rocket mr-2"></i>Microgravity
                </button>
                <button
                  type="button"
                  class="preset-btn text-xs py-2 px-3 bg-white text-gray-700 rounded-lg hover:bg-indigo-100 hover:text-indigo-800 transition shadow-sm hover:shadow-md border border-gray-200"
                  data-k="200"
                  data-c="0.25"
                  data-g="15">
                  <i class="fas fa-weight-hanging mr-2"></i>Heavy Damping
                </button>
                <button
                  type="button"
                  class="preset-btn text-xs py-2 px-3 bg-white text-gray-700 rounded-lg hover:bg-indigo-100 hover:text-indigo-800 transition shadow-sm hover:shadow-md border border-gray-200"
                  data-k="80"
                  data-c="0.05"
                  data-g="5">
                  <i class="fas fa-feather mr-2"></i>Light System
                </button>
              </div>
            </div>
          </div>

          <!-- Controls Tab -->
          <div id="controls-tab" class="tab-content">
            <div
              class="bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-100">
              <h3
                class="text-xs font-semibold text-gray-700 mb-2 uppercase tracking-wide">
                Simulation Controls
              </h3>
              <div class="space-y-2">
                <div class="flex gap-2">
                  <button
                    type="button"
                    id="pause-btn"
                    class="flex-1 py-2 px-3 bg-white text-gray-700 border border-gray-200 rounded-lg hover:bg-indigo-100 hover:text-indigo-800 text-xs shadow-sm hover:shadow-md transition font-medium">
                    <i class="fas fa-pause mr-2"></i>Pause
                  </button>
                  <button
                    type="button"
                    id="force-toggle-btn"
                    class="flex-1 py-2 px-3 bg-white text-gray-700 border border-gray-200 rounded-lg hover:bg-indigo-100 hover:text-indigo-800 text-xs shadow-sm hover:shadow-md transition font-medium">
                    <i class="fas fa-eye-slash mr-2"></i>Hide Forces
                  </button>
                </div>
                <button
                  type="button"
                  id="reset-btn"
                  class="w-full py-2 px-3 bg-white text-gray-700 border border-gray-200 rounded-lg hover:bg-indigo-100 hover:text-indigo-800 text-xs shadow-sm hover:shadow-md transition font-medium">
                  <i class="fas fa-redo mr-2"></i>Reset Simulation
                </button>
              </div>
            </div>
          </div>

          <!-- Guide Tab -->
          <div id="guide-tab" class="tab-content">
            <div
              class="bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-100">
              <h3
                class="text-xs font-semibold mb-2 text-gray-700 uppercase tracking-wide">
                Quick Guide
              </h3>
              <ul class="list-disc list-inside text-xs text-gray-600 space-y-1">
                <li><strong>Click</strong> empty canvas to add a mass</li>
                <li>
                  <strong>Click near</strong> two masses to connect with spring
                </li>
                <li>
                  <strong>Drag</strong> masses to move them during simulation
                </li>
                <li>
                  <strong>Double-click</strong> mass to fix/unfix position
                </li>
                <li><strong>Right-click</strong> on a spring to delete it</li>
                <li>
                  Springs: <span class="text-blue-600">Blue = Compressed</span>,
                  <span class="text-red-600">Red = Extended</span>
                </li>
                <li>
                  Fixed masses shown with
                  <span class="text-purple-600">X</span> (purple color)
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="mt-auto pt-3 text-xs text-gray-400">
          Spring-Mass Simulator &copy; 2024
        </div>
      </aside>

      <!-- Main Content Area -->
      <main
        id="main-content"
        class="main-content flex-1 flex flex-col bg-gray-50">
        <!-- Simulation Container -->
        <div id="simulation-container" class="simulation-container">
          <!-- Simulation Canvas -->
          <div class="canvas-container">
            <div class="flex items-center px-2 pb-1 w-full">
              <span class="font-semibold text-gray-700 text-xs">
                Energy Simulation
              </span>
            </div>
            <canvas
              id="sim-canvas"
              width="1200"
              height="600"
              class="rounded-xl shadow-lg border border-gray-200 bg-white w-full"
              style="max-height: 80vh">
            </canvas>
          </div>

          <!-- Energy Graph Section -->
          <div class="canvas-container mt-4">
            <div class="flex items-center justify-between px-2 pb-1 w-full">
              <span class="font-semibold text-gray-700 text-xs"
                >Energy Graph</span
              >
              <span id="energy-values" class="text-xs text-gray-500"></span>
            </div>
            <canvas
              id="energy-canvas"
              width="1200"
              height="150"
              class="rounded-xl shadow-lg border border-gray-200 bg-white w-full"
              style="max-height: 20vh"></canvas>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Physics Parameters
      let params = {
        stiffness: 100,
        damping: 0.05,
        gravity: 9.8,
        mass: 1.0,
      };

      // Canvas Elements
      const canvas = document.getElementById('sim-canvas');
      const ctx = canvas.getContext('2d');
      const energyCanvas = document.getElementById('energy-canvas');
      const ectx = energyCanvas.getContext('2d');
      const energyValuesText = document.getElementById('energy-values');

      // Simulation Data
      let masses = [];
      let springs = [];
      let forceVectors = [];

      // Controls
      let isPaused = false;
      let showForces = true;

      // Interaction State
      let dragTarget = null;
      let dragOffset = { x: 0, y: 0 };
      let connectMode = false;
      let connectStart = null;

      // Energy Tracking
      const ENERGY_HISTORY = 1000;
      let energyData = [];

      // Double-click Detection
      let lastClickTime = 0;
      let lastClickMass = null;

      // Data Classes
      class Mass {
        constructor(x, y, m = params.mass) {
          this.x = x;
          this.y = y;
          this.vx = 0;
          this.vy = 0;
          this.fx = 0;
          this.fy = 0;
          this.m = m;
          this.fixed = false;
        }
        get pos() {
          return [this.x, this.y];
        }
        set pos([x, y]) {
          this.x = x;
          this.y = y;
        }
      }

      class Spring {
        constructor(m1, m2, k = params.stiffness) {
          this.m1 = m1;
          this.m2 = m2;
          this.k = k;
          this.restLength = distance(m1, m2);
        }
      }

      function distance(a, b) {
        return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
      }

      // Simulation Setup
      function resetSimulation() {
        masses = [];
        springs = [];
        energyData = [];
        connectStart = null;
        connectMode = false;
        let p1 = new Mass(canvas.width / 2, 100, params.mass);
        p1.fixed = true;
        let p2 = new Mass(canvas.width / 2, 200, params.mass);
        masses.push(p1, p2);
        springs.push(new Spring(p1, p2, params.stiffness));
      }
      resetSimulation();

      // UI Event Handlers
      document
        .getElementById('settings-form')
        .addEventListener('input', (e) => {
          // Debounce parameter updates to prevent rapid changes
          clearTimeout(window.paramUpdateTimeout);
          window.paramUpdateTimeout = setTimeout(() => {
            const oldParams = { ...params };

            if (e.target.id === 'stiffness') {
              params.stiffness = Math.max(
                0.1,
                Math.min(1000, parseFloat(e.target.value) || 100),
              );
            }
            if (e.target.id === 'damping') {
              params.damping = Math.max(
                0,
                Math.min(10, parseFloat(e.target.value) || 0.05),
              );
            }
            if (e.target.id === 'gravity') {
              params.gravity = Math.max(
                0,
                Math.min(50, parseFloat(e.target.value) || 9.8),
              );
            }
            if (e.target.id === 'mass') {
              params.mass = Math.max(
                0.01,
                Math.min(10, parseFloat(e.target.value) || 1.0),
              );
            }

            // Smoothly update spring constants
            for (let s of springs) {
              s.k = params.stiffness;
            }

            // Reset velocities if parameters change significantly
            if (
              Math.abs(oldParams.gravity - params.gravity) > 1 ||
              Math.abs(oldParams.damping - params.damping) > 0.1
            ) {
              for (let m of masses) {
                if (!m.fixed) {
                  m.vx *= 0.5;
                  m.vy *= 0.5;
                }
              }
            }
          }, 100); // 100ms debounce
        });

      document.querySelectorAll('.preset-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          // Store old parameters
          const oldParams = { ...params };

          // Update parameters with validation
          params.stiffness = Math.max(
            0.1,
            Math.min(1000, parseFloat(btn.dataset.k) || 100),
          );
          params.damping = Math.max(
            0,
            Math.min(10, parseFloat(btn.dataset.c) || 0.05),
          );
          params.gravity = Math.max(
            0,
            Math.min(50, parseFloat(btn.dataset.g) || 9.8),
          );

          // Update input fields
          document.getElementById('stiffness').value = params.stiffness;
          document.getElementById('damping').value = params.damping;
          document.getElementById('gravity').value = params.gravity;

          // Smoothly update spring constants
          for (let s of springs) {
            s.k = params.stiffness;
          }

          // Reset velocities if parameters change significantly
          if (
            Math.abs(oldParams.gravity - params.gravity) > 1 ||
            Math.abs(oldParams.damping - params.damping) > 0.1
          ) {
            for (let m of masses) {
              if (!m.fixed) {
                m.vx *= 0.5;
                m.vy *= 0.5;
              }
            }
          }
        });
      });

      document.getElementById('reset-btn').addEventListener('click', () => {
        resetSimulation();
      });
      document.getElementById('pause-btn').addEventListener('click', (e) => {
        isPaused = !isPaused;
        e.target.innerHTML = isPaused
          ? '<i class="fas fa-play mr-2"></i>Resume'
          : '<i class="fas fa-pause mr-2"></i>Pause';
        e.target.className = isPaused
          ? 'flex-1 py-2.5 px-3 bg-white text-orange-700 border border-orange-200 rounded-lg hover:bg-orange-100 text-sm shadow-sm hover:shadow-md transition font-medium'
          : 'flex-1 py-2.5 px-3 bg-white text-blue-700 border border-blue-200 rounded-lg hover:bg-blue-100 text-sm shadow-sm hover:shadow-md transition font-medium';
      });

      document
        .getElementById('force-toggle-btn')
        .addEventListener('click', (e) => {
          showForces = !showForces;
          e.target.innerHTML = showForces
            ? '<i class="fas fa-eye-slash mr-2"></i>Hide Forces'
            : '<i class="fas fa-eye mr-2"></i>Show Forces';
          e.target.className = showForces
            ? 'flex-1 py-2.5 px-3 bg-white text-green-700 border border-green-200 rounded-lg hover:bg-green-100 text-sm shadow-sm hover:shadow-md transition font-medium'
            : 'flex-1 py-2.5 px-3 bg-white text-red-700 border border-red-200 rounded-lg hover:bg-gray-100 text-sm shadow-sm hover:shadow-md transition font-medium';
        });

      // Mouse Interaction
      function getMousePos(evt) {
        const rect = canvas.getBoundingClientRect();
        return {
          x: (evt.clientX - rect.left) * (canvas.width / rect.width),
          y: (evt.clientY - rect.top) * (canvas.height / rect.height),
        };
      }

      function findMassAt(x, y) {
        for (let m of masses) {
          if (Math.hypot(m.x - x, m.y - y) < 18) {
            return m;
          }
        }
        return null;
      }

      function springExists(m1, m2) {
        return springs.some(
          (s) => (s.m1 === m1 && s.m2 === m2) || (s.m1 === m2 && s.m2 === m1),
        );
      }

      canvas.addEventListener('mousedown', (e) => {
        const mouse = getMousePos(e);
        const foundMass = findMassAt(mouse.x, mouse.y);

        if (foundMass && !foundMass.fixed) {
          dragTarget = foundMass;
          dragOffset.x = foundMass.x - mouse.x;
          dragOffset.y = foundMass.y - mouse.y;
        }
      });

      canvas.addEventListener('mousemove', (e) => {
        if (dragTarget) {
          const mouse = getMousePos(e);
          dragTarget.x = mouse.x + dragOffset.x;
          dragTarget.y = mouse.y + dragOffset.y;
          dragTarget.vx = 0;
          dragTarget.vy = 0;
        }
      });

      canvas.addEventListener('mouseup', (e) => {
        dragTarget = null;
      });

      canvas.addEventListener('mouseleave', (e) => {
        dragTarget = null;
      });

      // Click handling for adding masses, connecting, and double-click
      canvas.addEventListener('click', (e) => {
        const mouse = getMousePos(e);
        const foundMass = findMassAt(mouse.x, mouse.y);
        const currentTime = Date.now();
        if (
          foundMass &&
          lastClickMass === foundMass &&
          currentTime - lastClickTime < 500
        ) {
          foundMass.fixed = !foundMass.fixed;
          foundMass.vx = 0;
          foundMass.vy = 0;
          lastClickMass = null;
          lastClickTime = 0;
          return;
        }

        lastClickMass = foundMass;
        lastClickTime = currentTime;

        if (foundMass) {
          if (connectStart === null) {
            connectStart = foundMass;
          } else if (
            connectStart !== foundMass &&
            !springExists(connectStart, foundMass)
          ) {
            springs.push(new Spring(connectStart, foundMass, params.stiffness));
            connectStart = null;
          } else {
            connectStart = foundMass;
          }
        } else {
          let newMass = new Mass(mouse.x, mouse.y, params.mass);
          masses.push(newMass);
          if (masses.length > 1) {
            let lastMass = masses[masses.length - 2];
            if (!springExists(lastMass, newMass)) {
              springs.push(new Spring(lastMass, newMass, params.stiffness));
            }
          }

          connectStart = null;
        }
      });

      // Physics Engine
      function step(dt) {
        if (isPaused) return;

        // Increase base timestep for faster animation
        dt = Math.min(dt * 2, 0.032); // Doubled the timestep, capped at ~30fps equivalent

        // Reset forces
        for (let m of masses) {
          m.fx = 0;
          m.fy = 0;
        }
        forceVectors = [];

        // Calculate spring forces with stability checks
        for (let s of springs) {
          let m1 = s.m1,
            m2 = s.m2;
          let dx = m2.x - m1.x,
            dy = m2.y - m1.y;
          let dist = Math.sqrt(dx * dx + dy * dy) || 1e-8;
          let ext = dist - s.restLength;

          // Limit extension to prevent extreme forces
          ext = Math.max(-100, Math.min(100, ext));

          // Spring force with stability and increased strength
          let fx = ((s.k * ext * dx) / dist) * 1.5; // Increased spring force
          let fy = ((s.k * ext * dy) / dist) * 1.5;

          // Damping force with stability
          let dvx = m2.vx - m1.vx;
          let dvy = m2.vy - m1.vy;
          let dampingForce = params.damping * ((dvx * dx + dvy * dy) / dist);
          let fdx = (dampingForce * dx) / dist;
          let fdy = (dampingForce * dy) / dist;

          // Apply forces with limits
          if (!m1.fixed) {
            m1.fx += Math.max(-1000, Math.min(1000, fx + fdx));
            m1.fy += Math.max(-1000, Math.min(1000, fy + fdy));
          }
          if (!m2.fixed) {
            m2.fx -= Math.max(-1000, Math.min(1000, fx + fdx));
            m2.fy -= Math.max(-1000, Math.min(1000, fy + fdy));
          }

          // Store force vectors for display
          if (showForces) {
            forceVectors.push({
              x1: m1.x,
              y1: m1.y,
              x2: m1.x + (fx + fdx) * 0.2,
              y2: m1.y + (fy + fdy) * 0.2,
              color: '#dc2626',
            });
            forceVectors.push({
              x1: m2.x,
              y1: m2.y,
              x2: m2.x - (fx + fdx) * 0.2,
              y2: m2.y - (fy + fdy) * 0.2,
              color: '#dc2626',
            });
          }
        }

        // Apply gravity and air resistance with stability
        for (let m of masses) {
          if (!m.fixed) {
            // Apply gravity with increased effect
            m.fy += m.m * params.gravity * 1.5; // Increased gravity effect
            // Apply air resistance with limits
            m.fx += Math.max(-100, Math.min(100, -params.damping * m.vx));
            m.fy += Math.max(-100, Math.min(100, -params.damping * m.vy));
          }
        }

        // Update positions with improved stability
        for (let m of masses) {
          if (!m.fixed && m !== dragTarget) {
            // Calculate acceleration with mass consideration and limits
            let ax = Math.max(-100, Math.min(100, m.fx / m.m));
            let ay = Math.max(-100, Math.min(100, m.fy / m.m));

            // Update velocity with improved stability
            m.vx += ax * dt;
            m.vy += ay * dt;

            // Apply velocity damping for stability
            m.vx *= 0.98; // Reduced damping for more movement
            m.vy *= 0.98;

            // Limit maximum velocity
            const maxVel = 1500; // Increased from 1000
            m.vx = Math.max(-maxVel, Math.min(maxVel, m.vx));
            m.vy = Math.max(-maxVel, Math.min(maxVel, m.vy));

            // Update position
            m.x += m.vx * dt;
            m.y += m.vy * dt;

            // Boundary collision with improved response
            if (m.x < 12) {
              m.x = 12;
              m.vx = Math.abs(m.vx) * 0.5; // Increased bounce
            }
            if (m.x > canvas.width - 12) {
              m.x = canvas.width - 12;
              m.vx = -Math.abs(m.vx) * 0.5;
            }
            if (m.y > canvas.height - 12) {
              m.y = canvas.height - 12;
              m.vy = -Math.abs(m.vy) * 0.5;
            }
            if (m.y < 12) {
              m.y = 12;
              m.vy = Math.abs(m.vy) * 0.5;
            }
          }
        }

        // Calculate energy with proper scaling
        let KE = 0,
          PE = 0;

        // Kinetic energy
        for (let m of masses) {
          KE += 0.5 * m.m * (m.vx ** 2 + m.vy ** 2);
          PE += m.m * params.gravity * m.y * 1.5; // Adjusted for new gravity scaling
        }

        // Spring energy
        for (let s of springs) {
          let d = distance(s.m1, s.m2);
          let ext = d - s.restLength;
          PE += 0.5 * s.k * ext ** 2 * 1.5; // Adjusted for new spring scaling
        }

        // Store energy data
        let totalE = KE + PE;
        energyData.push({
          ke: KE,
          pe: PE,
          total: totalE,
          t: performance.now() / 1000,
        });

        // Keep data within limits
        if (energyData.length > ENERGY_HISTORY) energyData.shift();
        energyValuesText.textContent = `KE: ${KE.toFixed(
          2,
        )} J | PE: ${PE.toFixed(2)} J | Total: ${totalE.toFixed(2)} J`;
      }

      // Rendering
      function draw() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw Springs
        for (let s of springs) {
          ctx.save();
          let currentLength = distance(s.m1, s.m2);
          let extension = currentLength - s.restLength;

          // Color: Red = stretched, Blue = compressed
          if (extension > 0) {
            ctx.strokeStyle = '#dc2626';
          } else {
            ctx.strokeStyle = '#2563eb';
          }

          // Thickness shows force
          ctx.lineWidth = Math.max(
            2,
            Math.min(6, Math.abs(extension) * 0.1 + 2),
          );
          ctx.beginPath();
          ctx.moveTo(s.m1.x, s.m1.y);
          ctx.lineTo(s.m2.x, s.m2.y);
          ctx.stroke();
          ctx.restore();
        }

        // Draw Force Vectors
        if (showForces) {
          for (let fv of forceVectors) {
            ctx.save();
            ctx.strokeStyle = fv.color;
            ctx.lineWidth = 2;

            // Draw line
            ctx.beginPath();
            ctx.moveTo(fv.x1, fv.y1);
            ctx.lineTo(fv.x2, fv.y2);
            ctx.stroke();

            // Draw arrow
            let dx = fv.x2 - fv.x1,
              dy = fv.y2 - fv.y1;
            let len = Math.sqrt(dx * dx + dy * dy);
            if (len > 6) {
              let ux = dx / len,
                uy = dy / len;
              ctx.beginPath();
              ctx.moveTo(fv.x2, fv.y2);
              ctx.lineTo(fv.x2 - 8 * ux + 4 * uy, fv.y2 - 8 * uy - 4 * ux);
              ctx.lineTo(fv.x2 - 8 * ux - 4 * uy, fv.y2 - 8 * uy + 4 * ux);
              ctx.closePath();
              ctx.fillStyle = fv.color;
              ctx.globalAlpha = 0.4;
              ctx.fill();
              ctx.globalAlpha = 1.0;
            }
            ctx.restore();
          }
        }

        // Draw Masses
        for (let m of masses) {
          ctx.save();
          ctx.beginPath();
          ctx.arc(m.x, m.y, 14, 0, 2 * Math.PI);

          // Color: Purple = fixed, Blue = moveable
          ctx.fillStyle = m.fixed ? '#9333ea' : '#818cf8';
          ctx.globalAlpha = 0.93;
          ctx.shadowColor = 'rgba(67,56,202,0.10)';
          ctx.shadowBlur = 5;
          ctx.fill();
          ctx.globalAlpha = 1.0;
          ctx.shadowBlur = 0;

          // Border
          ctx.strokeStyle = '#334155';
          ctx.lineWidth = 2.5;
          ctx.stroke();

          // Text: "X" for fixed, number for moveable
          ctx.font = '12px Inter, Arial';
          ctx.fillStyle = '#ffffff';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(m.fixed ? 'X' : masses.indexOf(m) + 1, m.x, m.y);
          ctx.restore();
        }

        // Interaction highlights
        if (dragTarget) {
          // Dragging highlight
          ctx.save();
          ctx.beginPath();
          ctx.arc(dragTarget.x, dragTarget.y, 19, 0, 2 * Math.PI);
          ctx.strokeStyle = '#f59e42';
          ctx.lineWidth = 3;
          ctx.setLineDash([5, 7]);
          ctx.stroke();
          ctx.restore();
        }
        if (connectStart) {
          // Connection highlight
          ctx.save();
          ctx.beginPath();
          ctx.arc(connectStart.x, connectStart.y, 19, 0, 2 * Math.PI);
          ctx.strokeStyle = '#10b981';
          ctx.lineWidth = 3;
          ctx.setLineDash([3, 5]);
          ctx.stroke();
          ctx.restore();
        }
      }

      // Energy Graph
      function drawEnergyGraph() {
        ectx.clearRect(0, 0, energyCanvas.width, energyCanvas.height);
        if (energyData.length < 2) return;

        // Calculate range
        let minE = Math.min(
          ...energyData.map((e) => Math.min(e.ke, e.pe, e.total)),
        );
        let maxE = Math.max(
          ...energyData.map((e) => Math.max(e.ke, e.pe, e.total)),
        );

        if (maxE - minE < 10) {
          minE -= 5;
          maxE += 5;
        }

        // Draw grid
        ectx.save();
        ectx.strokeStyle = '#e5e7eb';
        ectx.lineWidth = 1.2;

        ectx.beginPath();
        ectx.moveTo(0, energyCanvas.height - 18);
        ectx.lineTo(energyCanvas.width, energyCanvas.height - 18);
        ectx.stroke();

        ectx.beginPath();
        ectx.moveTo(30, 0);
        ectx.lineTo(30, energyCanvas.height);
        ectx.stroke();
        ectx.restore();

        // Draw Kinetic Energy (blue)
        ectx.save();
        ectx.strokeStyle = '#3b82f6';
        ectx.lineWidth = 2.2;
        ectx.beginPath();
        for (let i = 0; i < energyData.length; ++i) {
          let ex = 30 + i;
          let ey = mapE(energyData[i].ke, minE, maxE);
          if (i === 0) ectx.moveTo(ex, ey);
          else ectx.lineTo(ex, ey);
        }
        ectx.stroke();
        ectx.restore();

        // Draw Potential Energy (green)
        ectx.save();
        ectx.strokeStyle = '#10b981';
        ectx.lineWidth = 2.2;
        ectx.beginPath();
        for (let i = 0; i < energyData.length; ++i) {
          let ex = 30 + i;
          let ey = mapE(energyData[i].pe, minE, maxE);
          if (i === 0) ectx.moveTo(ex, ey);
          else ectx.lineTo(ex, ey);
        }
        ectx.stroke();
        ectx.restore();

        // Draw Total Energy (red dashed)
        ectx.save();
        ectx.strokeStyle = '#dc2626';
        ectx.lineWidth = 2.2;
        ectx.setLineDash([5, 5]);
        ectx.beginPath();
        for (let i = 0; i < energyData.length; ++i) {
          let ex = 30 + i;
          let ey = mapE(energyData[i].total, minE, maxE);
          if (i === 0) ectx.moveTo(ex, ey);
          else ectx.lineTo(ex, ey);
        }
        ectx.stroke();
        ectx.restore();

        // Draw labels
        ectx.save();
        ectx.font = 'bold 11px Inter, Arial';
        ectx.fillStyle = '#3b82f6';
        ectx.fillText('KE', 7, 20);
        ectx.fillStyle = '#10b981';
        ectx.fillText('PE', 7, 35);
        ectx.fillStyle = '#dc2626';
        ectx.fillText('Total', 7, 50);
        ectx.restore();
      }

      function mapE(e, minE, maxE) {
        const graphHeight = energyCanvas.height - 24;
        return 12 + graphHeight - ((e - minE) / (maxE - minE)) * graphHeight;
      }

      // Animation Loop
      let lastTime = null;
      function animate(t) {
        if (!lastTime) lastTime = t;
        const dt = Math.min((t - lastTime) / 1000, 0.035);
        lastTime = t;

        step(dt);
        draw();
        drawEnergyGraph();

        requestAnimationFrame(animate);
      }

      requestAnimationFrame(animate);

      // Add new JavaScript for sidebar toggle and tabs
      document.addEventListener('DOMContentLoaded', function () {
        // Sidebar toggle
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('settings-sidebar');

        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('hidden');
          const icon = sidebarToggle.querySelector('i');
          if (sidebar.classList.contains('hidden')) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
          } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
          }
        });

        // Tab switching
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach((button) => {
          button.addEventListener('click', () => {
            // Remove active class from all buttons and contents
            tabButtons.forEach((btn) => btn.classList.remove('active'));
            tabContents.forEach((content) =>
              content.classList.remove('active'),
            );

            // Add active class to clicked button and corresponding content
            button.classList.add('active');
            const tabId = button.dataset.tab + '-tab';
            document.getElementById(tabId).classList.add('active');
          });
        });

        // Handle window resize
        function handleResize() {
          const sidebar = document.getElementById('settings-sidebar');
          const mainContent = document.getElementById('main-content');
          const simulationContainer = document.getElementById(
            'simulation-container',
          );
          const canvas = document.getElementById('sim-canvas');
          const energyCanvas = document.getElementById('energy-canvas');

          const isSidebarHidden = sidebar.classList.contains('hidden');
          const containerWidth = isSidebarHidden
            ? window.innerWidth
            : window.innerWidth - 320;

          // Update canvas sizes
          canvas.width = Math.min(containerWidth - 32, 1200);
          energyCanvas.width = Math.min(containerWidth - 32, 1200);

          // Update container classes
          mainContent.classList.toggle('expanded', isSidebarHidden);
          simulationContainer.classList.toggle('expanded', isSidebarHidden);

          // Update canvas containers
          document
            .querySelectorAll('.canvas-container')
            .forEach((container) => {
              container.classList.toggle('expanded', isSidebarHidden);
            });
        }

        window.addEventListener('resize', handleResize);
        handleResize();
      });

      function findSpringAt(x, y) {
        for (let s of springs) {
          let m1 = s.m1,
            m2 = s.m2;
          let dx = m2.x - m1.x;
          let dy = m2.y - m1.y;
          let dist = Math.sqrt(dx * dx + dy * dy);

          // Calculate distance from point to line segment
          let t = ((x - m1.x) * dx + (y - m1.y) * dy) / (dx * dx + dy * dy);
          t = Math.max(0, Math.min(1, t));

          let closestX = m1.x + t * dx;
          let closestY = m1.y + t * dy;

          let distance = Math.hypot(x - closestX, y - closestY);

          if (distance < 10) {
            // Click threshold for springs
            return s;
          }
        }
        return null;
      }

      // Add right-click handler for spring deletion
      canvas.addEventListener('contextmenu', (e) => {
        e.preventDefault(); // Prevent default context menu
        const mouse = getMousePos(e);
        const foundSpring = findSpringAt(mouse.x, mouse.y);

        if (foundSpring) {
          // Remove the spring
          springs = springs.filter((s) => s !== foundSpring);
        }
      });
    </script>
  </body>
</html>
